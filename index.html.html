/* ====== Mobile/iPhone Compatibility (v1) â€” safe to append at file end ====== */
(function(){
  if (window.MobileCompatV1) return; window.MobileCompatV1 = true;

  // --- A) localStorage shim (iOS Safari private mode throws on setItem) -----
  (function(){
    let ok = true;
    try { const k='__t'; localStorage.setItem(k,'1'); localStorage.removeItem(k); }
    catch(e){ ok = false; }
    if (!ok){
      const mem = {};
      const shim = {
        getItem: k => (k in mem ? mem[k] : null),
        setItem: (k,v) => { mem[k] = String(v); },
        removeItem: k => { delete mem[k]; },
        clear: () => { for (const k in mem) delete mem[k]; },
        key: i => Object.keys(mem)[i] || null,
        get length(){ return Object.keys(mem).length; }
      };
      try { Object.defineProperty(window, 'localStorage', { value: shim, configurable:true }); }
      catch(_){ window.localStorage = shim; }
    }
  })();

  // --- B) iOS 100vh fix via --vh variable -----------------------------------
  function setVh(){
    const vh = window.innerHeight * 0.01;
    document.documentElement.style.setProperty('--vh', `${vh}px`);
  }
  setVh();
  window.addEventListener('resize', setVh);
  window.addEventListener('orientationchange', setVh);

  // --- C) Mobile-friendly CSS tweaks (tap, safe areas, grid) -----------------
  const css = `
    body, #activityPanel { padding-bottom: max(env(safe-area-inset-bottom), 8px); }
    #activityPanel * { -webkit-tap-highlight-color: transparent; }
    #activityPanel button { min-height: 36px; padding: 8px 10px; touch-action: manipulation; }
    #activityPanel .card { border-radius: 14px; }
    /* Make card grid wrap nicely on narrow screens */
    #pcGrid { grid-template-columns: repeat(auto-fill, minmax(180px,1fr)) !important; }
  `;
  const style = document.createElement('style');
  style.textContent = css;
  document.head.appendChild(style);

  // --- D) Fast-tap: trigger button clicks on touchstart inside activityPanel -
  const ap = document.getElementById('activityPanel');
  if (ap){
    ap.addEventListener('touchstart', (e)=>{
      const b = e.target.closest('button');
      if (!b || b.disabled) return;
      b.click();            // fire immediately
      e.preventDefault();   // prevent duplicate "ghost" click
    }, { passive:false });
  }

  // --- E) Gentle auto-fit for People grid on open ----------------------------
  const mo = new MutationObserver(()=>{
    const grid = document.getElementById('pcGrid');
    if (grid) grid.style.minHeight = 'calc(var(--vh, 1vh) * 40)';
  });
  mo.observe(document.body, { childList:true, subtree:true });

})();
